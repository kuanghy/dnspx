DNS 报文格式
========

DNS报文是DNS协议中请求（Query）和响应（Response）的基本数据单元，其格式遵循RFC 1035标准。以下简单介绍 DNS 报文的结构。

### DNS 报文整体结构

DNS 报文由 5 个部分 组成，采用二进制格式：

- 首部（Header）
- 问题部分（Question Section）（仅查询请求）
- 回答部分（Answer Section）（响应中的资源记录）
- 授权部分（Authority Section）（指向权威服务器的记录）
- 附加部分（Additional Section）（额外的辅助信息）

```
+---------------------+
|        Header       | → 固定12字节
+---------------------+
|       Question      | → 查询请求的问题列表
+---------------------+
|        Answer       | → 响应的资源记录（RR）
+---------------------+
|      Authority      | → 权威服务器的资源记录
+---------------------+
|      Additional     | → 附加资源记录（如IP地址）
+---------------------+
```

### 首部（Header）

首部固定为 12字节，包含控制字段和计数器：

```
0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     ID（事务ID）                |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|QR| Opcode |AA|TC|RD|RA| Z|AD|CD|   RCODE       |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QDCOUNT（问题数）            |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ANCOUNT（回答记录数）         |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    NSCOUNT（权威记录数）         |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ARCOUNT（附加记录数）         |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

- **ID（事务ID）（16位）：** 请求与响应的唯一标识符，用于匹配查询和应答。

- **Flags（标志字段）（16位）：**
    - QR（1位）：报文类型，0表示查询，1表示响应。
    - Opcode（4位）：操作类型，常见值：
        - 0：标准查询（QUERY）
        - 1：反向查询（IQUERY）
        - 2：服务器状态请求（STATUS）
    - AA（1位）：权威应答（仅响应有效，表示应答来自权威服务器）。
    - TC（1位）：截断标志（当响应超过UDP 512字节时置1，需改用TCP）。
    - RD（1位）：递归请求（客户端要求递归解析）。
    - RA（1位）：递归可用（服务器支持递归查询）。
    - 保留位，这 3 位目前未用，留作未来扩展。
    - RCODE（4位）：响应码，常见值：
        - 0：无错误
        - 2：服务器故障（SERVFAIL）
        - 3：域名不存在（NXDOMAIN）

- **计数器字段（各16位）：**
    - QDCOUNT：问题部分的问题数量（通常为1）。
    - ANCOUNT：回答部分的资源记录（RR）数量。
    - NSCOUNT：权威部分的RR数量。
    - ARCOUNT：附加部分的RR数量。

### 问题部分（Question Section）

问题部分定义查询的目标域名和类型，每个问题格式如下：

```
0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QNAME（域名）               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QTYPE（查询类型）            |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QCLASS（查询类）             |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

- **QNAME：** 域名编码，采用 标签序列 格式（如 www.example.com 编码为 3www7example3com0）。
- **QTYPE（16位）：** 查询类型，常见值：
    - 1：A记录（IPv4地址）
    - 2：NS记录（名称服务器）
    - 5：CNAME记录（别名）
    - 15：MX记录（邮件服务器）
    - 16：TXT（文本信息）
    - 28：AAAA记录（IPv6地址）
- **QCLASS（16位）：** 查询类，通常为 1（IN，Internet）。


### 资源记录（RR）格式

回答、授权和附加部分均使用资源记录（Resource Record）格式：

```
0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    NAME（域名）                |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    TYPE（记录类型）             |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    CLASS（类）                 |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    TTL（生存时间）              |
|                                               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    RDLENGTH（数据长度）         |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    RDATA（数据）               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

- **NAME：** 域名（可能使用指针压缩，如 0xc00c 指向报文中的其他位置）。
- **TYPE（16位）：** 记录类型（同QTYPE）。
- **CLASS（16位）：** 类（通常为1，表示IN）。
- **TTL（32位）：** 生存时间（秒），决定缓存有效期。
- **RDLENGTH（16位）：** RDATA的字节长度。
- **RDATA：** 记录数据，格式依TYPE不同：
    - A记录：4字节IPv4地址。
    - AAAA记录：16字节IPv6地址。
    - CNAME记录：压缩编码的别名域名。
    - MX记录：优先级（16位） + 邮件服务器域名。


### DNS报文示例

**查询报文（请求）**

```
Header:
  ID: 0x1234
  Flags: QR=1, AA=1, RA=1, RCODE=0
  QDCOUNT=1, ANCOUNT=1, NSCOUNT=2, ARCOUNT=1

Question:
  QNAME: 3www7example3com0
  QTYPE: 1
  QCLASS: 1

Answer:
  NAME: 0xc00c (指针，指向Question中的域名)
  TYPE: 1 (A记录)
  CLASS: 1
  TTL: 300
  RDATA: 93.184.216.34

Authority:
  NS记录：example.com的权威服务器（略）

Additional:
  A记录：权威服务器的IP地址（略）
```
